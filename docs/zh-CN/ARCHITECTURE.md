# NexusPanel 架构文档

## 文档信息

- **版本**: v1.0
- **状态**: 有效
- **最后更新**: 2024
- **作者**: NexusPanel Team

---

## 目录

1. [系统概述](#系统概述)
2. [架构原则](#架构原则)
3. [系统架构](#系统架构)
4. [组件设计](#组件设计)
5. [数据流](#数据流)
6. [安全架构](#安全架构)
7. [部署架构](#部署架构)
8. [可扩展性与性能](#可扩展性与性能)

---

## 系统概述

### 目的

NexusPanel 是一个现代化的云原生服务器管理平台，旨在通过直观的 Web 界面为服务器、容器和云资源提供统一的管理能力。

### 关键特性

- **模块化**: 基于插件的可扩展性
- **云原生**: 容器化部署，Kubernetes 就绪
- **多租户**: 支持多组织（未来）
- **实时性**: 基于 WebSocket 的实时监控
- **国际化**: 多语言支持（zh-CN, en-US）
- **安全**: 行业标准安全实践

### 技术栈

#### 后端
- **语言**: Go 1.21+
- **Web 框架**: Gin
- **ORM**: GORM
- **数据库**: PostgreSQL 13+ / SQLite 3.x
- **缓存**: Redis（可选）
- **配置**: Viper
- **日志**: Zap
- **认证**: JWT

#### 前端
- **框架**: Vue 3 (Composition API)
- **语言**: TypeScript
- **构建工具**: Vite
- **样式**: TailwindCSS
- **状态管理**: Pinia
- **路由**: Vue Router
- **国际化**: vue-i18n

---

## 架构原则

### 1. 关注点分离

系统分为具有明确职责的不同层次：
- **表现层**: UI 组件和用户交互
- **API 层**: RESTful 端点和 WebSocket 处理器
- **业务逻辑层**: 核心应用逻辑
- **数据访问层**: 数据库操作和模型
- **基础设施层**: 外部服务和工具

### 2. 模块化

- 核心功能在 \`internal/\` 包中
- 可复用工具在 \`pkg/\` 包中
- 插件系统实现可扩展性
- 清晰的模块边界

### 3. 无状态

- 基于 JWT 的认证（无状态）
- 水平可扩展性
- 会话数据存储在数据库/缓存中
- 无服务器端会话存储

### 4. API 优先设计

- 明确定义的 RESTful API
- OpenAPI/Swagger 文档
- API 版本控制 (\`/api/v1/\`)
- 一致的响应格式

### 5. 默认安全

- 生产环境强制 HTTPS
- 输入验证和清理
- SQL 注入防护
- XSS 防护
- CSRF 防护
- 频率限制
- 审计日志

---

## 系统架构

### 高层架构

\`\`\`
┌─────────────────────────────────────────────────────────────┐
│                        客户端层                              │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐     │
│  │  Web 浏览器  │  │  移动应用    │  │   CLI 工具   │     │
│  │  (Vue 3)     │  │   (未来)     │  │   (未来)     │     │
│  └──────┬───────┘  └──────┬───────┘  └──────┬───────┘     │
└─────────┼──────────────────┼──────────────────┼─────────────┘
          │                  │                  │
          │ HTTPS / WSS      │ HTTPS            │ HTTPS
          ▼                  ▼                  ▼
┌─────────────────────────────────────────────────────────────┐
│                   反向代理层 (Nginx)                         │
│              ┌────────────────────────────────┐              │
│              │    SSL/TLS 终结                │              │
│              │    负载均衡                     │              │
│              │    频率限制                     │              │
│              └────────────────────────────────┘              │
└────────────────────────────┬────────────────────────────────┘
                             │
                             ▼
┌─────────────────────────────────────────────────────────────┐
│                      API 网关层                              │
│              (Gin 框架 + 中间件)                             │
│  ┌──────────────────────────────────────────────────────┐  │
│  │ 中间件链:                                             │  │
│  │  • CORS                                              │  │
│  │  • 认证 (JWT)                                         │  │
│  │  • 授权 (RBAC)                                        │  │
│  │  • 频率限制                                           │  │
│  │  • 请求日志                                           │  │
│  │  • 错误处理                                           │  │
│  │  • 国际化                                             │  │
│  └──────────────────────────────────────────────────────┘  │
└────────────────────────────┬────────────────────────────────┘
                             │
          ┌──────────────────┼──────────────────┐
          │                  │                  │
          ▼                  ▼                  ▼
┌──────────────────┐ ┌──────────────────┐ ┌──────────────────┐
│   REST 处理器    │ │ WebSocket 处理器 │ │  gRPC 处理器     │
│                  │ │                  │ │   (未来)         │
│  • 用户 API      │ │  • 指标流        │ │                  │
│  • 服务器 API    │ │  • 终端          │ │  • Agent 通信    │
│  • 监控 API      │ │  • 事件          │ │                  │
└────────┬─────────┘ └────────┬─────────┘ └────────┬─────────┘
         │                    │                     │
         └────────────────────┼─────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────┐
│                   业务逻辑层                                 │
│  ┌─────────────┐ ┌─────────────┐ ┌─────────────┐          │
│  │    认证     │ │   服务器    │ │    监控     │          │
│  │    模块     │ │    模块     │ │    模块     │          │
│  └─────────────┘ └─────────────┘ └─────────────┘          │
│  ┌─────────────┐ ┌─────────────┐ ┌─────────────┐          │
│  │    用户     │ │    任务     │ │   插件      │          │
│  │    模块     │ │    模块     │ │   引擎      │          │
│  └─────────────┘ └─────────────┘ └─────────────┘          │
└────────────────────────────┬────────────────────────────────┘
                             │
                             ▼
┌─────────────────────────────────────────────────────────────┐
│                    数据访问层                                │
│                     (GORM + 模型)                            │
│  ┌─────────────────────────────────────────────────────┐   │
│  │ 数据库模型:                                          │   │
│  │  • User, Role, Token                                │   │
│  │  • Server, ServerGroup, SSHKey                      │   │
│  │  • Metric, Alert, AlertRule                         │   │
│  │  • Task, TaskLog                                    │   │
│  │  • Plugin, PluginSetting                            │   │
│  └─────────────────────────────────────────────────────┘   │
└────────────────────────────┬────────────────────────────────┘
                             │
          ┌──────────────────┼──────────────────┐
          │                  │                  │
          ▼                  ▼                  ▼
┌──────────────────┐ ┌──────────────────┐ ┌──────────────────┐
│   PostgreSQL     │ │      Redis       │ │     文件存储     │
│   (主数据库)     │ │     (缓存)       │ │                  │
│                  │ │                  │ │                  │
│  • 用户数据      │ │  • 会话          │ │  • 上传文件      │
│  • 服务器信息    │ │  • 临时数据      │ │  • 日志          │
│  • 监控数据      │ │  • 频率限制      │ │  • 备份          │
└──────────────────┘ └──────────────────┘ └──────────────────┘

┌─────────────────────────────────────────────────────────────┐
│                    外部系统                                  │
│  ┌─────────────┐ ┌─────────────┐ ┌─────────────┐          │
│  │   目标      │ │    邮件     │ │    云存储   │          │
│  │   服务器    │ │    服务     │ │   (S3/OSS)  │          │
│  │   (SSH)     │ │   (SMTP)    │ │             │          │
│  └─────────────┘ └─────────────┘ └─────────────┘          │
└─────────────────────────────────────────────────────────────┘
\`\`\`

---

## 组件设计

### 1. 前端架构 (Vue 3)

\`\`\`
web/
├── src/
│   ├── components/          # 可复用 UI 组件
│   │   ├── common/         # 通用组件 (Button, Input)
│   │   ├── charts/         # 图表组件
│   │   └── forms/          # 表单组件
│   │
│   ├── views/              # 页面组件
│   │   ├── LoginView.vue
│   │   ├── DashboardView.vue
│   │   ├── ServersView.vue
│   │   └── MonitoringView.vue
│   │
│   ├── stores/             # Pinia 状态管理
│   │   ├── auth.ts         # 认证状态
│   │   ├── servers.ts      # 服务器管理状态
│   │   └── monitoring.ts   # 监控状态
│   │
│   ├── router/             # Vue Router 配置
│   │   └── index.ts        # 路由定义
│   │
│   ├── api/                # API 客户端
│   │   ├── client.ts       # Axios 实例
│   │   ├── auth.ts         # 认证 API 调用
│   │   ├── servers.ts      # 服务器 API 调用
│   │   └── monitoring.ts   # 监控 API 调用
│   │
│   ├── i18n/               # 国际化
│   │   ├── index.ts        # i18n 配置
│   │   ├── zh-CN.ts        # 中文翻译
│   │   └── en-US.ts        # 英文翻译
│   │
│   └── utils/              # 工具函数
\`\`\`

### 2. 后端架构 (Go)

\`\`\`
cmd/
├── server/                 # 主服务器应用
│   └── main.go            # 入口点
└── agent/                 # Agent 应用（未来）
    └── main.go

internal/                   # 私有应用代码
├── api/                   # API 层
│   ├── router.go          # 路由定义
│   ├── middleware/        # HTTP 中间件
│   └── handlers/          # HTTP 处理器
│
├── core/                  # 业务逻辑
│   ├── auth/             # 认证逻辑
│   ├── user/             # 用户管理逻辑
│   ├── server/           # 服务器管理逻辑
│   └── monitor/          # 监控逻辑
│
├── database/             # 数据库层
│   ├── database.go       # 数据库连接
│   ├── models/           # GORM 模型
│   └── migrations/       # SQL 迁移
│
└── plugins/              # 插件系统
    ├── engine.go        # 插件加载器
    └── registry.go      # 插件注册表

pkg/                      # 公共库
├── config/              # 配置管理
├── logger/              # 日志工具
├── crypto/              # 加密工具
└── utils/               # 通用工具
\`\`\`

---

## 数据流

### 1. 服务器添加流程

\`\`\`
1. 用户在前端填写表单
2. 前端验证输入
3. POST /api/v1/servers 携带服务器详情
4. 认证中间件验证 JWT
5. 处理器验证请求体
6. 服务器模块:
   - 测试 SSH 连接
   - 获取系统信息
   - 在数据库中创建服务器记录
7. 返回成功响应
8. 前端更新服务器列表
9. 后台任务开始监控
\`\`\`

### 2. 告警处理流程

\`\`\`
1. 监控模块收集指标
2. 对比指标与告警规则
3. 如果超过阈值:
   - 创建告警记录
   - 触发通知服务
4. 告警显示在 UI 中（WebSocket）
5. 用户可以确认/解决告警
6. 数据库中更新告警状态
\`\`\`

---

## 安全架构

### 1. 认证

- **JWT 令牌**: 无状态认证
- **令牌类型**: 访问令牌（短期）+ 刷新令牌（长期）
- **密码要求**: 最少 8 字符，包含大小写字母和数字
- **密码哈希**: 使用 bcrypt，成本因子 10
- **首次登录**: 强制修改默认密码

### 2. 授权

- **RBAC**: 基于角色的访问控制
- **角色**: admin, operator, user, guest
- **权限**: 端点级别的细粒度权限
- **中间件**: 处理器前的授权检查

### 3. 数据保护

- **静态加密**: 
  - SSH 密钥使用 AES-256 加密
  - 数据库密码加密
- **传输加密**: 生产环境强制 HTTPS/WSS
- **敏感数据**: 不记录日志或在错误中暴露

### 4. 输入验证

- **请求验证**: 所有输入都经过验证
- **SQL 注入防护**: 参数化查询（GORM）
- **XSS 防护**: 输出转义
- **CSRF 防护**: SameSite cookies + CSRF tokens

### 5. 频率限制

- **认证端点**: 每个 IP 每分钟 10 次请求
- **API 端点**: 每个用户每分钟 100 次请求
- **WebSocket**: 每个用户最多 5 个并发连接

### 6. 审计日志

记录所有敏感操作:
- 用户登录/登出
- 用户创建/删除
- 服务器添加/移除
- 配置更改

---

## 部署架构

### 1. 单服务器部署

\`\`\`
┌──────────────────────────────────────┐
│         单服务器                       │
│                                       │
│  ┌─────────────────────────────────┐│
│  │         Nginx                    ││
│  │  (反向代理 + 静态文件)           ││
│  └─────────────┬───────────────────┘│
│                │                     │
│  ┌─────────────▼───────────────────┐│
│  │      NexusPanel Server          ││
│  │       (Go 二进制)                ││
│  └─────────────┬───────────────────┘│
│                │                     │
│  ┌─────────────▼───────────────────┐│
│  │       PostgreSQL                ││
│  └─────────────────────────────────┘│
└──────────────────────────────────────┘
\`\`\`

### 2. Docker Compose 部署

\`\`\`yaml
services:
  web:
    image: nginx:alpine
    ports: ["80:80", "443:443"]
  
  api:
    image: nexuspanel/server:latest
    environment:
      - DB_HOST=db
      - REDIS_HOST=redis
  
  db:
    image: postgres:13
    volumes:
      - postgres_data:/var/lib/postgresql/data
  
  redis:
    image: redis:7-alpine
\`\`\`

---

## 可扩展性与性能

### 1. 水平扩展

- **无状态 API**: 可运行多个实例
- **负载均衡器**: Nginx/HAProxy 进行分发
- **会话存储**: Redis 用于共享状态
- **数据库**: 读副本扩展读操作

### 2. 性能优化

- **数据库索引**: 在频繁查询的列上
- **连接池**: 复用数据库连接
- **缓存策略**: 
  - Redis 缓存频繁访问的数据
  - 内存缓存配置数据
- **查询优化**: 
  - 避免 N+1 查询
  - 适当使用预加载
- **资源优化**:
  - 压缩的 JS/CSS
  - Gzip 压缩
  - CDN 静态资源（未来）

### 3. 监控与可观测性

- **指标**: Prometheus 兼容指标
- **日志**: 结构化日志（JSON 格式）
- **追踪**: 分布式追踪（未来）
- **健康检查**: \`/health\` 端点检查就绪状态

---

**文档结束**
